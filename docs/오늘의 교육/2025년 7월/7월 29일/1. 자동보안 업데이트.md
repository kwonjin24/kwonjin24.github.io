---
layout: default
title: 1. 자동보안 업데이트 
parent: 7월 29일
nav_order: 3
---

# 2025년 7월 29일 교육 내용

오늘 배운 내용을 여기에 정리합니다.

## 이 프로젝트의 전체 목표
이 예제는 **재사용 가능한 Ansible 역할(Role)**을 만들어, 서버에 자동으로 보안 업데이트를 적용하고 설정하는 과정을 보여주는 것입니다. "역할"은 특정 작업을 수행하는 독립적인 자동화 부품과 같습니다.

## 프로젝트 구성 분석
이 프로젝트는 크게 1) 역할(Role) 정의 부분과 2) 역할을 사용하는 플레이북 부분으로 나뉩니다.

## 1. unattended_upgrades 역할(Role) 정의 - '자동 업데이트 설치 설명서'
roles/unattended_upgrades 디렉터리 안에 있는 파일들이 해당됩니다. 이것은 '자동 업데이트를 어떻게 설치하고 설정하는지'에 대한 재사용 가능한 설명서입니다.

defaults/main.yml: '기본 설정값' 파일입니다. 이 역할이 사용할 기본 변수(알림 이메일 주소, 재부팅 시간)를 미리 정해둡니다. 나중에 플레이북에서 다른 값을 지정하지 않으면 이 기본값이 사용됩니다.

templates/ 디렉터리 안의 .j2 파일들: 실제 서버 설정 파일의 '설계도(Blueprint)'입니다. {{ unattended_mail_to }} 처럼 비어있는 부분이 있어서, 플레이북이 실행될 때 실제 값으로 채워집니다.

tasks/main.yml: '작업 순서'를 정의한 파일입니다.

Install unattended-upgrades package: 먼저, 자동 업데이트에 필요한 프로그램을 서버에 설치합니다.

Configure ... settings: 그 다음, templates 디렉터리에 있던 '설계도' 파일들을 가져와 변수를 채운 뒤, 실제 설정 파일을 서버의 올바른 위치(/etc/apt/apt.conf.d/)에 배포(복사)합니다.

## 2. site.yml 플레이북 - '작업 지시서'
이 파일은 위에서 만든 '자동 업데이트 설치 설명서(Role)'를 어떤 서버에, 어떤 특별한 설정을 적용하여 실행할지 지시하는 역할을 합니다.

hosts: all: 인벤토리(inventory.ini)에 있는 모든 서버를 대상으로 작업을 지시합니다.

roles: - role: unattended_upgrades: unattended_upgrades 역할을 이 서버들에서 실행하라고 지시합니다.

vars:: 역할의 '기본 설정값'을 덮어쓰는 특별 지시사항입니다. 여기서는 기본값(root@localhost) 대신 알림 이메일을 admin@example.com으로, 재부팅 시간은 04:00으로 변경하라고 지시합니다.

when: ansible_os_family == "Debian": 이 역할은 서버의 OS가 데비안 계열(우분투 등)일 때만 실행하라는 조건을 지정합니다.

## 요약
이 예제는 재사용 가능한 **'설명서(Role)'**를 먼저 만들고, 그 설명서를 **'작업 지시서(Playbook)'**에서 불러와 특정 서버에 맞게 일부 내용을 변경하여 적용하는, 매우 체계적이고 효율적인 자동화 방식을 보여줍니다.

ksh001@ksh001:~$

mkdir unattended_upgrades
cd unattended_upgrades

```
cat<<EOF>>inventory.ini
an-ksh002 ansible_host=10.10.8.201
EOF
```

mkdir roles

ansible-galaxy init unattended_upgrades --init-path ./roles

touch roles/unattended_upgrades/templates/20auto-upgrades.j2
touch roles/unattended_upgrades/templates/50unattended-upgrades.j2

ksh001@ksh001:~/unattended_upgrades$
vi inventory.ini

```
an-ksh004 ansible_host=10.10.8.203
```

ksh001@ksh001:~/unattended_upgrades/roles/unattended_upgrades$
vi main.yml
```
 ;defaults file for unattended_upgrades
unattended_mail_to: "root@localhost"
unattended_reboot_time: "03:00"
```

ksh001@ksh001:~/unattended_upgrades/roles/unattended_upgrades/templates$
vi 50unattended-upgrades.j2

```
// Ansible managed
Unattended-Upgrade::Allowed-Origins {
    "${distro_id}:${distro_codename}-security";
};

Unattended-Upgrade::Package-Blacklist {
};

Unattended-Upgrade::Mail "{{ unattended_mail_to }}";
Unattended-Upgrade::Automatic-Reboot "true";
Unattended-Upgrade::Automatic-Reboot-Time "{{ unattended_reboot_time }}";
```

ksh001@ksh001:~/unattended_upgrades/roles/unattended_upgrades/templates$
vi 20auto-upgrades.j2

```
// Ansible managed
APT::Periodic::Update-Package-Lists "1";
APT::Periodic::Unattended-Upgrade "1";
```

ksh001@ksh001:~/unattended_upgrades/roles/unattended_upgrades/tasks$
vi main.yml

```
; tasks file for unattended_upgrades
- name: Install unattended-upgrades package
  ansible.builtin.apt:
    name: unattended-upgrades
    state: present
    update_cache: yes

- name: Configure main settings for unattended-upgrades
  ansible.builtin.template:
    src: 50unattended-upgrades.j2
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    owner: root
    group: root
    mode: '0644'

- name: Configure activation settings for unattended-upgrades
  ansible.builtin.template:
    src: 20auto-upgrades.j2
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    owner: root
    group: root
    mode: '0644'
```

ksh001@ksh001:~/unattended_upgrades$
vi site.yml

```
- name: Apply base configuration to all Ubuntu servers
  hosts: all
  become: true
  roles:
    - role: unattended_upgrades
      vars:
        ; 기본값을 덮어쓰고 싶을 때만 변수를 정의
        unattended_mail_to: "admin@example.com"
        unattended_reboot_time: "04:00"
      when: ansible_os_family == "Debian" ; Debian 계열에서만 실행
```

ansible-playbook site.yml -i inventory.ini

ansible all -i inventory.ini -m shell -a "dpkg -l | grep unattended-upgrades" --become

ansible all -i inventory.ini -m command -a "cat /etc/apt/apt.conf.d/20auto-upgrades" --become

ansible all -i inventory.ini -m command -a "cat /etc/apt/apt.conf.d/50unattended-upgrades" --become

