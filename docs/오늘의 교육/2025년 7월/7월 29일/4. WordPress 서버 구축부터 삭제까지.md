---
layout: default
title: 4. WordPress 서버 구축부터 삭제까지
parent: 7월 29일
nav_order: 128
---

# 2025년 7월 29일 교육 내용

오늘 배운 내용을 여기에 정리합니다.


## 이 프로젝트의 전체 목표
이것은 워드프레스(WordPress) 웹사이트를 처음부터 끝까지 자동으로 설치하고, 필요 없게 되면 깨끗하게 삭제하는 전체 과정을 담은 매우 완성도 높은 Ansible 프로젝트입니다.

---------------

## 1단계: 프로젝트 준비 및 파일 설명
프로젝트를 시작하기 위해 필요한 파일들을 정의하는 단계입니다.

ansible.cfg, hosts: Ansible의 기본 설정과 관리할 서버 목록을 정의하는 파일입니다.

requirements.yml: ansible-galaxy를 통해 다운로드할 전문가용 역할(Role)들의 목록입니다.
(학습 참고: 이 예제에서는 requirements.yml에 역할을 정의해놓고, 실제 playbook.yml에서는 역할을 사용하지 않고 직접 모든 작업을 수행하고 있습니다. 두 가지 방식 중 하나를 선택하는 것이 일반적이며, 이 예제는 직접 모든 것을 제어하며 배우는 데 초점을 맞춘 것으로 보입니다.)

.j2 파일 (템플릿): wp-config.php와 Nginx 설정 파일의 **'설계도'**입니다. {{ db_name }}과 같은 변수(빈칸)를 가지고 있다가, 플레이북이 실행될 때 실제 값으로 채워져 최종 설정 파일이 됩니다.

---------------

## 2단계: 설치 플레이북 (playbook.yml) 분석
이 파일은 워드프레스를 설치하는 모든 작업 지시를 담은 핵심 스크립트입니다.

MariaDB 준비:

보안상의 이유로 MariaDB(MySQL) 데이터베이스의 root 비밀번호를 먼저 안전하게 설정합니다. skip-grant-tables는 이를 위해 잠시 인증 단계를 건너뛰는 고급 기술입니다.

데이터베이스 생성:

community.mysql 모듈을 사용해 워드프레스가 사용할 전용 데이터베이스(wordpress)와 사용자(wordpress_user)를 생성하고 권한을 부여합니다.

PHP 및 워드프레스 파일 준비:

uri 모듈로 워드프레스 보안키를 인터넷에서 실시간으로 가져옵니다.

file 모듈로 워드프레스 파일이 설치될 웹사이트의 최상위 디렉터리(/var/www/wordpress)를 생성합니다.

template 모듈로 wp-config.php.j2 설계도에 DB 정보와 보안키를 채워 넣어 최종 wp-config.php 설정 파일을 만듭니다.

unarchive 모듈로 워드프레스 최신 버전을 다운로드하고 웹사이트 디렉터리에 압축을 풉니다.

Nginx 웹 서버 설정:

template 모듈로 wordpress.conf.j2 설계도를 이용해 Nginx 설정 파일을 만듭니다.

file 모듈로 만든 설정을 활성화(심볼릭 링크 생성)하고, 기본 사이트는 비활성화(삭제)합니다.

notify와 handlers를 이용해 설정 변경이 있을 때만 Nginx 서비스를 자동으로 재시작합니다.

---------------

## 3단계: 클린업 플레이북 (cleanup.yml) 분석
이것은 설치된 워드프레스를 깨끗하게 제거하는 역할을 하는 별도의 작업 지시서입니다.

서비스 중지: Nginx, MariaDB, PHP 서비스를 모두 중지하고 비활성화합니다. ignore_errors: true는 이미 서비스가 없어도 오류 없이 넘어가게 합니다.

파일 삭제: Nginx 설정 파일, 워드프레스 웹사이트 디렉터리, MariaDB 데이터 디렉터리 등 생성했던 모든 파일을 삭제합니다.

패키지 완전 삭제: apt 모듈의 purge: yes, autoremove: yes 옵션을 사용해 설치했던 모든 패키지를 설정 파일과 불필요한 의존성 패키지까지 포함하여 완전히 제거합니다.

요약
이 프로젝트는 단순히 프로그램을 설치하는 것을 넘어, 데이터베이스 설정, 보안키 발급, 동적 설정 파일 생성, 서비스 관리 등 실제 웹사이트를 배포하는 데 필요한 거의 모든 과정을 자동화하고 있습니다. 또한, 설치뿐만 아니라 완전한 제거까지 자동화하여 인프라를 코드(IaC)로 관리하는 모범적인 예시입니다.


cd ~
mkdir -p ~/ansible-wordpress/templates

touch ansible.cfg hosts requirements.yml playbook.yml \
templates/wordpress.conf.j2 templates/wp-config.php.j2

ksh001@ksh001:~/ansible-wordpress$
vi ansibel.cfg

```
[defaults]
inventory = ./hosts
remote_user = ubuntu
host_key_checking = False

[privilege_escalation]
become = true
become_method = sudo
become_user = root
become_ask_pass = false
```

ksh001@ksh001:~/ansible-wordpress$
vi hosts

```
[web_servers]
an-ksh002 ansible_host=10.10.8.201
an-ksh003 ansible_host=10.10.8.202
an-ksh004 ansible_host=10.10.8.203
an-ksh005 ansible_host=10.10.8.204

[control_node]
an-ksh001 ansible_host=10.10.8.200 ansible_connection=local

[all:children]
web_servers
control_node

[all:vars]
ansible_ssh_private_key_file = ~/.ssh/id_rsa
```

```
cat <<EOF>>requirements.yml 
--- 
roles:
 - name: geerlingguy.nginx
 - name: geerlingguy.mysql
 - name: geerlingguy.php
 - name: Oefenweb.wordpress 
EOF
```

vi playbook.yml

```
---
- hosts: an-ksh002
  become: true

  vars:
    db_root_password: "P@ssw0rd"
    db_name: "wordpress"
    db_user: "wordpress_user"
    db_password: "P@ssw0rd"
    wordpress_path: /var/www/wordpress
    wordpress_domain: "{{ ansible_host }}"
    php_version: "8.3"

  tasks:

    - name: Install all required packages
      ansible.builtin.apt:
        name:
          - mariadb-server
          - python3-mysqldb
          - nginx
          - php-fpm
          - php-mysql
          - php-gd
        state: present
        update_cache: yes

    - name: Stop MariaDB to enter bootstrap mode
      ansible.builtin.service:
        name: mariadb
        state: stopped

    - name: Create bootstrap config to disable grant tables
      ansible.builtin.copy:
        content: |
          [mysqld]
          skip-grant-tables
        dest: /etc/mysql/mariadb.conf.d/99-bootstrap.cnf

    - name: Start MariaDB in bootstrap mode
      ansible.builtin.service:
        name: mariadb
        state: started

    - name: Forcibly set the root password
      ansible.builtin.command: >
        mysql -u root -e "FLUSH PRIVILEGES;
        ALTER USER 'root'@'localhost' IDENTIFIED BY '{{ db_root_password }}';"
      changed_when: true

    - name: Remove bootstrap config file
      ansible.builtin.file:
        path: /etc/mysql/mariadb.conf.d/99-bootstrap.cnf
        state: absent

    - name: Restart MariaDB in normal mode
      ansible.builtin.service:
        name: mariadb
        state: restarted

    - name: Create the wordpress database
      community.mysql.mysql_db:
        name: "{{ db_name }}"
        state: present
        login_user: root
        login_password: "{{ db_root_password }}"

    - name: Create the wordpress database user
      community.mysql.mysql_user:
        name: "{{ db_user }}"
        password: "{{ db_password }}"
        priv: "{{ db_name }}.*:ALL"
        state: present
        login_user: root
        login_password: "{{ db_root_password }}"

    - name: Ensure php-fpm service is started and enabled
      ansible.builtin.service:
        name: php{{ php_version }}-fpm
        state: started
        enabled: yes

    - name: Get WordPress security salts
      ansible.builtin.uri:
        url: https://api.wordpress.org/secret-key/1.1/salt/
        return_content: yes
      register: wordpress_salts

    - name: Create WordPress document root
      ansible.builtin.file:
        path: "{{ wordpress_path }}"
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Create wp-config.php from template
      ansible.builtin.template:
        src: templates/wp-config.php.j2
        dest: "{{ wordpress_path }}/wp-config.php"
        owner: www-data
        group: www-data
        mode: '0640'

    - name: Download and unpack latest WordPress
      ansible.builtin.unarchive:
        src: https://wordpress.org/latest.tar.gz
        dest: "{{ wordpress_path }}"
        remote_src: yes
        extra_opts: [--strip-components=1]
        owner: www-data
        group: www-data

    - name: Create Nginx virtual host for WordPress
      ansible.builtin.template:
        dest: /etc/nginx/sites-available/wordpress
        src: templates/wordpress.conf.j2
      notify: Restart Nginx

    - name: Enable the new virtual host
      ansible.builtin.file:
        src: /etc/nginx/sites-available/wordpress
        dest: /etc/nginx/sites-enabled/wordpress
        state: link
      notify: Restart Nginx

    - name: Remove default Nginx site
      ansible.builtin.file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: Restart Nginx

  handlers:
    - name: Restart Nginx
      ansible.builtin.service:
        name: nginx
        state: restarted
```

cd ~/ansible-wordpress/templates 
vi wp-config.php.j2

```
<?php
define( 'DB_NAME', '{{ db_name }}' );
define( 'DB_USER', '{{ db_user }}' );
define( 'DB_PASSWORD', '{{ db_password }}' );
define( 'DB_HOST', '127.0.0.1' );
define( 'DB_CHARSET', 'utf8' );
define( 'DB_COLLATE', ' ');

{{ wordpress_salts.content }}

$table_prefix = 'wp_';

define( 'WP_DEBUG', false );

if ( ! defined( 'ABSPATH' ) ) {
    define( 'ABSPATH', __DIR__ . '/' );
}

require_once ABSPATH . 'wp-settings.php';
```

vi wordpress.conf.j2 

```
server {
    listen 80;
    server_name {{ wordpress_domain }};
    root {{ wordpress_path }};
    index index.php index.html index.htm;

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass unix:/var/run/php/php{{ php_version }}-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
}
```

## an-ksh002
1.  an-node1에서 apache2 실행중이면 먼저 동작 중지
    sudo systemctl stop apache2 
    sudo systemctl disable apache2 

## an-ksh001
2.  ksh001 사용자로 로그인된 상태
3.  cd ~ 
4.  cd ansible-wordpress 
5.  ansible-galaxy install -r requirements.yml
6.  ansible-playbook -i hosts playbook.yml -i '10.10.8.201,' 
7.  윈도우에 접근
 http://10.10.8.201

## 클린업
1.  vi cleanup.yml 

```
---
- hosts: an-ksh002
#- hosts: web_servers  # an-ksh002 대신 그룹 이름 사용
  become: true

  vars:
    # 삭제할 경로를 지정하기 위해 설치 플레이북의 변수를 그대로 사용합니다.
    wordpress_path: /var/www/wordpress
    php_version: "8.3"

  tasks:
    - name: Stop and disable all related services
      ansible.builtin.service:
        name: "{{ item }}"
        state: stopped
        enabled: no
      loop:
        - nginx
        - mariadb
        - "php{{ php_version }}-fpm"
      ignore_errors: true  # 이미 삭제된 서비스가 있어도 에러 없이 진행

    - name: Remove Nginx virtual host files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/nginx/sites-enabled/wordpress
        - /etc/nginx/sites-available/wordpress

    - name: Remove WordPress web root directory
      ansible.builtin.file:
        path: "{{ wordpress_path }}"
        state: absent

    - name: Purge all related packages
      ansible.builtin.apt:
        name:
          - mariadb-server
          - python3-mysqldb
          - nginx
          - php-fpm
          - php-mysql
          - php-gd
        state: absent
        purge: yes        # 설정 파일까지 모두 삭제
        autoremove: yes   # 의존성 패키지 자동 삭제

    - name: Remove leftover MariaDB data and config directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /var/lib/mysql
        - /etc/mysql
```

ansible-playbook -i hosts cleanup.yml -i '10.10.8.201,' 

## an-ksh002 호스트만 대상으로 실행
ansible-playbook playbook.yml --limit an-ksh002
