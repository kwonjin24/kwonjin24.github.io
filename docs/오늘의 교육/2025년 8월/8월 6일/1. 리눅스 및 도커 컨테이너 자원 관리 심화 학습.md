---
layout: default
title: 리눅스 및 도커 컨테이너 자원 관리 심화 학습
parent: 8월 6일
nav_order: 2
---

# 2025년 8월 6일 교육 내용

컨테이너를 생성을 할때 cpu, Ram, ssd을 제한 하여 생산을 한다

## util-linux lshw lsmem lscpu 설치

* apt-file은 어떤 파일이 어떤 패키지에 포함되어 있는지 검색할 때 사용
sudo apt install apt-file

* 사용할 패키지 파일 목록 데이터베이스를 업데이트
sudo apt-file update

* /bin/lshw라는 파일이 어떤 패키지에 속해 있는지 검색
apt-file search /bin/lshw

* lshw 패키지를 설치
sudo apt install lshw

* 패키지는 lsmem, lscpu, fdisk, mount 등 리눅스 시스템을 관리하는 데 필요한 매우 다양한 기본 유틸리티들을 모아놓은 패키지
sudo apt install util-linux

* 시스템의 하드웨어 정보를 자세히 보여주는 명령어
sudo lshw

* 시스템의 하드웨어 간략하게 보는 명령어
sudo lshw -short

-----------------------------------------------------

## 리눅스 시스템의 상태와 하드웨어 정보를 확인
* 시스템의 CPU 정보를 자세하게 보여줍니다.
lscpu

* 시스템의 메모리(RAM) 정보를 보여줍니다.
lsmem

* 시스템에 연결된 블록 장치(Block devices), 즉 하드 디스크, SSD, USB 드라이브 등의 정보를 계층 구조로 보여줍니다.
lsblk

* 시스템의 메모리 사용 현황을 실시간으로 보여줍니다.
free

-----------------------------------------------------

## 도커 컨테이너를 생성하고 메모리 관련 설정을 확인하는 일련의 과정

* 메모리 제한을 512m로 설정한 nginx114 컨테이너를 만듭니다.
docker run -dit -m 512m --name nginx114 nginx:1.14

* 현재 실행 중인 컨테이너들의 CPU, 메모리, 네트워크 사용량을 실시간으로 모니터링
watch docker stats

* 현재 컨테이너들의 자원 사용량을 보여
docker stats

* nginx114 컨테이너의 모든 메타데이터를 JSON 형식으로 출력합니다. 이 정보에는 설정된 메모리 제한 값도 포함됩니다.
docker inspect nginx114

* docker inspect 출력 내용 중 대소문자를 구분하지 않고(-i) "memory"가 포함된 라인만 필터링하여 보여줍니다. 이를 통해 -m 옵션이 잘 적용되었는지 확인할 수 있습니다.
docker inspect nginx114 | grep -i memory

* 512m를 사용하는데 256m만큼은 절대 줄수 없는 공간으로 만듬
docker run -dit -m 512m --memory-reservation 256m --name nginx115 nginx:1.14

@ 컨테이너의 메모리 사용량이 시스템의 메모리 부족으로 인해 줄어들더라도 256MB 아래로는 내려가지 않도록 하는 설정입니다. 이 값은 soft 제한이고, -m 512m가 hard 제한 역할을 합니다.

oom(Out of me) kill-disable
soft 제한 
약간 메모리를 넘겨도 됨
hard 제한
메모리를 절때 넘겨도 안됨

* OOM Killer라는 리눅스 커널 기능이 메모리가 부족할 때 이 컨테이너를 강제로 종료하지 않도록 합니다.
docker run -dit -m 512m --oom-kill-disable --name nginx116 nginx:1.14

* --memory-swap 2048m: 이 컨테이너가 사용할 수 있는 메모리(RAM)와 스왑(Swap) 메모리의 총합을 2048m로 제한합니다.

-m 512m와 함께 사용하면, RAM을 512MB까지만 쓰고, 남은 1536MB는 스왑 공간을 사용하도록 허용하는 설정입니다. 스왑 공간은 디스크를 사용하기 때문에 RAM보다 훨씬 느립니다
docker run -dit -m 512m --memory-swap 2048m --name nginx117 nginx:1.14

* 실행 중이거나 중지된 모든 컨테이너를 한 번에 강제로 삭제하는 명령어
docker rm -f $(docker ps -aq)

-----------------------------------------------------

## 컨테이너 CPU 및 메모리 제한
* --cpus 0.5: 컨테이너가 호스트 시스템의 **CPU 리소스 중 0.5개(즉, 50%)**만 사용하도록 제한합니다. 이는 CPU 코어의 절대적인 개수를 지정하는 것이 아니라, 사용 가능한 CPU 시간의 비율을 할당하는 것입니다.

1. docker run -dit --name nginx114 --cpus='0.5' --memory 512m nginx:1.14
2. docker run -dit --name nginx114 --cpus 0.5 --memory 512m nginx:1.14


## 컨테이너 CPU 가중치 설정
* 시스템의 CPU 리소스가 부족하여 여러 컨테이너가 CPU를 놓고 경쟁할 때, cpu-shares 값이 높은 컨테이너가 더 많은 CPU 시간을 할당받습니다. 예를 들어, nginx115와 nginx116이 동시에 CPU를 많이 필요로 한다면, nginx115가 nginx116보다 2배 더 많은 CPU를 할당받게 됩니다. CPU가 충분할 때는 이 옵션이 큰 영향을 미치지 않습니다.

1. docker run -dit --name nginx115 --cpu-shares 1024 nginx:1.14
2. docker run -dit --name nginx116 --cpu-shares 512 nginx:1.14

## 컨테이너 블록 I/O 가중치 및 IOPS 제한
* 여러 컨테이너가 동시에 디스크 I/O를 많이 사용할 때, blkio-weight 값이 높은 컨테이너가 디스크 대역폭을 더 많이 할당받게 됩니다. 이는 CPU cpu-shares와 유사하게, 디스크 자원 경쟁 시 우선순위를 부여하는 방식입니다.

1. docker run -dit --blkio-weight 100 --name nginx121 nginx:1.14


* --device-read-iops /dev/sda:10: /dev/sda 장치에서 nginx122 컨테이너가 초당 최대 10번의 읽기 작업만 수행하도록 제한합니다.
2. docker run -dit --device-read-iops /dev/sda:10 --name nginx122 nginx:1.14


* 이 두 device-*-iops 옵션은 컨테이너가 특정 디스크 장치에 대해 과도한 읽기/쓰기 작업을 수행하여 시스템 전체의 디스크 성능을 저하시키는 것을 방지할 때 사용합니다.
3. docker run -dit --device-write-iops /dev/sda:10 --name nginx123 nginx:1.14

-----------------------------------------------------
## 도커 컨테이너 자원 제어 및 성능 테스트

apt-file search /bin/stress
sudo apt install stress

docker run -dit --device-write-iops /dev/sda:10 --name nginx124 nginx:1.14 /usr/bin/yes

docker stats

-----------------------------------------------------
## 도커 컨테이너 빌드, 자원 제한 및 내부 명령어 실행 실습

mkdir stress
cd stress/

vi Dockerfile

```
FROM ubuntu:latest
MAINTAINER na@goole.com
RUN apt update \
&& apt install stress -y \
&& apt clean

CMD ["/bin/bash","-c","stress -c 2"]
```

docker build -t stress .

docker run -dit --cpus 0.1 --name nginx01 stress
docker run -dit --cpus 0.1 --name nginx02 stress

docker exec nginx02 bash -c "stress -c"

-----------------------------------------------------

docker-compose
--여러개의 커넽이너를 작동
--yaml로 리소스 제한

## Docker Compose를 활용한 컨테이너 자원 관리

cd stress/

vi docker-compose.yml

### cpu와 ram제한
```
services:
  nginx:
    image: nginx:1.14
    container_name: my-nginx
    # 메모리(RAM) 제한
    mem_limit: 512m
    # CPU 제한 (20% 사용)
    cpus: 0.2

  redis:
    image: redis:latest
    container_name: my-redis
    # 메모리(RAM) 제한
    mem_limit: 256m
    # CPU 제한 (50% 사용)
    cpus: 0.5
```

### cpu와 ram제한 후 스트레스 
```
services:
  nginx:
    image: nginx:1.14
    container_name: my-nginx
    mem_limit: 512m
    cpus: 0.2

  redis:
    image: redis:latest
    container_name: my-redis
    mem_limit: 256m
    cpus: 0.5
  
  stress_test:
    image: stress:latest  # 이전에 빌드한 stress 이미지를 사용
    container_name: my-stress
    mem_limit: 100m
    cpus: 0.5
    command: stress -c 2 -m 1 --vm-bytes 50M
```

docker compose down -v 
docker compose up -d
docker compose stop

docker stats