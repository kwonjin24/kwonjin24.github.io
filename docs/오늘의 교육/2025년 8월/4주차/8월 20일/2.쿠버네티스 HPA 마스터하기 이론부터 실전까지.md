---
layout: default
title: 
parent: 8월 20일
nav_order: 3
---

# 2025년 8월 20일 교육 내용

# 쿠버네티스

## 📌 쿠버네티스 HPA(Horizontal Pod Autoscaler) 완벽 정리
1) HPA란 무엇인가?
HPA(Horizontal Pod Autoscaler)는 애플리케이션의 리소스 사용량(주로 CPU)에 따라 Pod의 개수를 자동으로 늘리거나 줄이는 쿠버네티스의 핵심 기능입니다. 트래픽이 몰리면 Pod를 늘려 서비스 안정성을 유지하고, 한가할 때는 Pod를 줄여 컴퓨팅 자원을 효율적으로 사용합니다.

👉 쉬운 비유: 스마트 에어컨 온도조절기
CPU 사용률이 목표치보다 높아지면 → Pod 개수를 늘려 부하를 분산합니다. (냉방 강화)
CPU 사용률이 목표치보다 낮아지면 → Pod 개수를 줄여 자원을 절약합니다. (냉방 완화)

쿠버네티스의 다른 오토스케일링 방식
VPA (Vertical Pod Autoscaler): Pod의 개별 크기(CPU/메모리 요청량)를 조절합니다.
CA (Cluster Autoscaler): 클러스터의 노드(서버) 개수를 조절합니다.

2) HPA의 작동 원리 (Control Loop)
HPA 컨트롤러는 다음과 같은 과정을 주기적으로(기본 15초) 반복하며 동작합니다.

메트릭 수집 (Collect): Metrics Server로부터 scaleTargetRef에 지정된 모든 Pod의 현재 리소스 사용량(예: CPU)을 가져옵니다.
필요 Pod 수 계산 (Calculate): 현재 값과 목표 값을 아래 공식에 따라 비교하여 필요한 Pod 개수를 계산합니다.
원하는 Pod 수 = ceil[ 현재 Pod 수 × ( 현재 메트릭 값 / 목표 메트릭 값 ) ]

계산 예시:
현재 Pod 수: 3개
현재 평균 CPU 사용률: 90%
목표 평균 CPU 사용률: 50%
계산: ceil[ 3 * ( 90 / 50 ) ] = ceil[ 5.4 ] = 6개

결과: Pod를 3개에서 6개로 확장해야 한다고 결정합니다.

스케일링 실행 (Scale): 계산된 결과를 바탕으로 대상 리소스(주로 Deployment)의 replicas 수를 변경합니다.

3) HPA의 핵심 설정 (YAML 분석)
HPA를 정의하는 YAML 파일의 주요 필드는 다음과 같습니다.

YAML
```
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: my-app-hpa
spec:
  # 1. 어떤 리소스를 스케일링할지 지정
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: my-app
    
  # 2. Pod 개수의 최소/최대 범위 지정
  minReplicas: 2
  maxReplicas: 10
  
  # 3. 어떤 메트릭을 기준으로 삼을지 지정
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 50 # Pod의 평균 CPU 사용률이 50%가 되도록 유지

  # 4. 스케일링 동작을 세밀하게 제어 (선택 사항)
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300 # 300초(5분) 동안 조건이 유지되어야 축소 실행
      policies:
      - type: Pods
        value: 1
        periodSeconds: 60 # 60초마다 최대 1개의 Pod만 축소
    scaleUp:
      stabilizationWindowSeconds: 0 # 즉시 확장 실행
      policies:
      - type: Percent
        value: 100
        periodSeconds: 15 # 15초마다 현재 Pod의 100% 만큼 확장 가능
```

behavior 필드: 스케일링이 너무 급격하게 일어나는 것을 방지(Flapping)하는 중요한 옵션입니다. 특히 scaleDown의 stabilizationWindowSeconds는 부하가 줄어든 후에도 일정 시간(기본 5분) 동안 상태를 지켜본 뒤 Pod 수를 줄이도록 하여 안정성을 높입니다.

4) HPA의 장점과 주의사항
✅ 장점
탄력적인 서비스: 트래픽 급증 상황에서도 자동으로 대응하여 서비스 안정성을 유지합니다.
비용 효율성: 유휴 리소스를 최소화하여 인프라 비용을 절감할 수 있습니다.

## ⚠️ 주의사항
Metrics Server 필수: HPA가 동작하려면 클러스터에 반드시 Metrics Server가 설치되어 있어야 합니다.
느린 반응 속도: 반응이 즉각적이지 않고 수십 초에서 수 분이 소요될 수 있어, 아주 짧은 순간의 부하(Spike)에는 대응하기 어렵습니다.
requests 설정 필수: CPU 사용률(Utilization) 기반으로 HPA를 사용하려면, 대상이 되는 Pod에 반드시 resources.requests.cpu가 설정되어 있어야 합니다.
적절한 min/max 설정: 안정적인 운영을 위해 최소/최대 Pod 개수를 적절하게 산정하는 것이 중요합니다.

## 🎯 핵심 요약
HPA는 Pod의 개수를 자동으로 조절하는 기능입니다.
Metrics Server를 통해 CPU/메모리 사용량을 주기적으로 확인합니다.
Deployment의 replicas 수를 변경하는 방식으로 동작합니다.
실무에서는 안정적인 운영을 위해 behavior 설정을 통해 스케일링 속도를 조절하는 것이 좋습니다.

--------------------------------------------------------------------------

## 🚀 HPA 실습: 수평적 파드 자동 확장 마스터하기 (최종 완성본)
#### 🎯 목표: CPU 사용량에 따라 Pod의 개수를 자동으로 늘리거나(Scale-Out) 줄이는(Scale-Down) HPA(Horizontal Pod Autoscaler) 기능을 직접 실습합니다.

1단계: 사전 준비 - Metrics Server 설치
HPA는 Pod의 CPU 사용량과 같은 메트릭 정보가 필요하며, 이 정보는 Metrics Server가 수집합니다.

Metrics Server 설치:

Bash
```
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
```
설치 확인:
metrics-server Pod가 Running 상태가 될 때까지 1~2분 정도 기다립니다.

Bash
```
kubectl get pod -n kube-system | grep metrics-server
```
⚠️ 문제 해결: 만약 Pod가 정상 실행되지 않으면, kubectl edit deploy -n kube-system metrics-server로 spec.template.spec.containers.args 섹션에 --kubelet-insecure-tls 옵션을 추가하세요.

2단계: 실습 환경 구성 (Deployment, Service, HPA)
⚠️ 실습 전 중요 확인사항
Metrics Server: 위 1단계가 성공하여 metrics-server Pod가 반드시 Running 상태여야 합니다.

CPU Requests: HPA가 CPU 사용률(%)을 계산하려면, 아래 YAML처럼 Deployment의 Pod 템플릿에 resources.requests.cpu가 반드시 설정되어 있어야 합니다.

vi hpa-test-env.yaml
YAML
```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-nginx
spec:
  replicas: 2
  selector:
    matchLabels:
      app: web-nginx
  template:
    metadata:
      labels:
        app: web-nginx
    spec:
      containers:
      - name: nginx
        image: nginx:latest
        resources:
          requests:
            cpu: 200m
---
apiVersion: v1
kind: Service
metadata:
  name: clusterip-service
spec:
  type: ClusterIP
  selector:
    app: web-nginx
  ports:
  - port: 80
    targetPort: 80
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: hpa-nginx
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: web-nginx
  minReplicas: 2
  maxReplicas: 8
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 50
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 60
```

리소스 배포:
Bash
```
kubectl apply -f hpa-test-env.yaml
kubectl get deploy,svc,hpa
```

3단계: 부하 생성 및 Scale-Out 확인
임시 Pod를 생성하여 Nginx 서비스에 트래픽을 보내 인위적으로 CPU 사용량을 높입니다.

서비스 IP 확인:
Bash
```
kubectl get svc clusterip-service
```

모니터링 및 부하 생성 (터미널 3개 사용 추천):

(터미널 1) HPA 상태 모니터링: HPA가 언제, 어떻게 반응하는지 관찰합니다.

Bash
```
$ kubectl get hpa hpa-nginx --watch
```

(터미널 2) Pod 리소스 사용량 모니터링: 각 Pod의 실제 CPU 사용량을 직접 확인합니다.

Bash
```
watch kubectl top pods
```

(터미널 3) 부하 생성: 확인한 <CLUSTER_IP>로 요청을 보내는 임시 Pod를 실행합니다.

Bash
```
kubectl run -i --tty load-generator --rm --image=busybox:1.28 --restart=Never \
  -- /bin/sh -c "while sleep 0.01; do wget -q -O- http://<CLUSTER_IP>; done"
```
✨ 핵심 관찰 포인트:

터미널 2에서 web-nginx Pod들의 CPU 사용량이 급증하는 것을 확인합니다.

터미널 1에서 TARGETS 값이 50%를 넘어서면, REPLICAS 수가 2에서 점차 증가하는 것을 확인하세요.

HPA 이벤트 확인:
HPA가 어떤 이유로 스케일링을 결정했는지 상세 이벤트 로그를 통해 확인할 수 있습니다.
Bash
```
kubectl describe hpa hpa-nginx
```

출력 하단의 Events 섹션에서 SuccessfulRescale 이벤트를 찾아보세요.

4단계: 부하 제거 및 Scale-Down 확인
부하 제거: load-generator Pod 터미널에서 Ctrl + C를 눌러 종료합니다.

HPA 상태 모니터링: HPA 상태를 계속 관찰합니다.

Bash
```
kubectl get hpa hpa-nginx --watch
```
✨ 핵심 관찰 포인트: CPU 사용률이 급격히 떨어져도 Pod 개수는 바로 줄어들지 않습니다. YAML에 정의된 stabilizationWindowSeconds: 60 때문에 60초 동안 낮은 부하가 유지된 후에야 Pod 수가 최소 개수인 2개로 다시 줄어듭니다.

5단계: 실습 리소스 정리
Bash
```
kubectl delete -f hpa-test-env.yaml
```

💡 심화 학습 포인트
부하 시뮬레이션 팁: wget 루프는 간단한 테스트에 유용하지만, 실제와 유사한 트래픽을 만들려면 ab(Apache Benchmark)나 hey 같은 전문 부하 테스트 도구를 사용하는 것이 좋습니다.

HPA behavior 정책: HPA의 behavior 필드를 사용하면 "1분에 최대 1개의 Pod만 축소" 또는 "15초마다 현재 Pod의 100% 만큼 확장"과 같이 스케일링 동작을 훨씬 더 세밀하게 제어할 수 있어, 서비스 안정성을 크게 높일 수 있습니다.